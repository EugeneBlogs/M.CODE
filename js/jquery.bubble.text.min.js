(window||this).bubbleText=function(l){if(l!==Object(l)||l.map===[].map)throw"bubbleText: Missing properties";var a=$(l.element),t=a[0];if(!t)throw"bubbleText: Missing element";if(a.find(":first").length)throw"bubbleText: Element must be one leaf node";var n=l.newText;if("string"!=typeof n)throw"bubbleText: Missing newText";var e=t.innerHTML,i={position:"relative",float:"left",overflow:"hidden"},o=$("<span>. .</span>").appendTo(a).css(i);function r(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e.charAt(n);t[n]={char:r,html:$('<span class="span-bubble-text">'+r+"</span>").appendTo(a)}," "===r&&t[n].html.width(o)}return t}o=o.width()-2*o.html(".").width(),t.innerHTML="";for(var h=r(n),s=r(e),p=[];h.length;){var f=h.shift(),d={add:f,width:f.html.width()+"px"};f.html.width(0);for(var c=f.char,v=0,b=s.length;v<b;v++)if(c===s[v].char){d.remove=s.splice(v,1)[0];break}p.push(d)}var m=0;if(l.hasOwnProperty("proportional")||(l.proportional=!0),l.proportional){var u=s.length,g=p.length;for(g<u?(u=Math.ceil(u/g),g=1):(g=Math.ceil(g/u),u=1);s.length;)if(m<p.length){for(var w=s.splice(0,u);w.length;)p.splice(m,0,{remove:w.shift()}),m++;m+=g}else p.push({remove:s.shift()})}else for(;s.length;){d={remove:s.shift()};m<p.length?(p.splice(m,0,d),m+=2):p.push(d)}var T=a.find("span"),x=a.css("line-height");i.height=/\d/.test(x)?x:$(T[0]).height()+"px",T.css(i);var M=parseInt(l.letterSpeed)||Math.floor((l.speed||2e3)/p.length),H=[" ",".",",","-"],L='<br clear="all">';return l.stop=function(){a.find("span").stop()},l.finish=function(e){l.stop(),t.innerHTML=n,e&&"function"==typeof l.callback&&l.callback()},l.restart=function(){l.stop(),t.innerHTML=e,$.extend(l,bubbleText(l))},function e(t){var n=p[t];if(!n)return l.finish(!0),void(l.repeat--&&setTimeout(l.restart,l.timeBetweenRepeat||1500));function i(){e(t+1)}var r,a={duration:M,complete:i,easing:"linear"};n.add&&(r=n.add.html,a.complete=function(){var e=" "===r.html();e||r.css("width","auto");var t=r.prev("span");if(t.length&&t.offset().top!==r.offset().top)if(e)r.replaceWith(L);else{for(;-1===H.indexOf(t.html())&&0!==(t=t.prev("span")).length;);t.after(L)}i()},r.animate({width:n.width},a)),n.remove&&n.remove.html.animate({width:0},n.add?{duration:M,easing:"linear"}:a)}(0),l};